name: Auto PR â€” develop â†’ main

on:
  push:
    branches:
      - develop

permissions:
  contents: read
  pull-requests: write

jobs:
  # â”€â”€ 1. CI completo antes de qualquer coisa â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci:
    name: CI (Build & Test)
    runs-on: ubuntu-latest

    outputs:
      passed: ${{ steps.result.outputs.passed }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Build
        run: go build -v ./...

      - name: Vet
        run: go vet ./...

      - name: Test
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Mark passed
        id: result
        if: success()
        run: echo "passed=true" >> $GITHUB_OUTPUT

  # â”€â”€ 2. Verifica se hÃ¡ commits novos e gera corpo da PR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  generate-pr-body:
    name: Generate PR description (AI)
    runs-on: ubuntu-latest
    needs: ci
    if: needs.ci.outputs.passed == 'true'

    outputs:
      pr_body:      ${{ steps.ai.outputs.pr_body }}
      commit_count: ${{ steps.commits.outputs.count }}
      pr_title:     ${{ steps.commits.outputs.title }}
      has_diff:     ${{ steps.commits.outputs.has_diff }}

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch main branch
        run: git fetch origin main:main 2>/dev/null || git fetch origin main 2>/dev/null || true

      - name: Collect commits develop â†’ main
        id: commits
        run: |
          echo "--- Branch info ---"
          git branch -a

          echo ""
          echo "--- HEAD ---"
          git log -3 --oneline

          echo ""
          echo "--- origin/main ---"
          git log origin/main -3 --oneline 2>/dev/null || echo "(main not found or empty)"

          # Commits em develop que nÃ£o estÃ£o em main
          COMMITS=$(git log origin/main..HEAD --oneline --no-merges 2>/dev/null || \
                    git log main..HEAD --oneline --no-merges 2>/dev/null || \
                    git log --oneline --no-merges -20)

          echo ""
          echo "--- Commits develop â†’ main ---"
          echo "$COMMITS"
          echo "---"

          if [ -z "$(echo "$COMMITS" | tr -d '[:space:]')" ]; then
            echo "âš ï¸ No commits ahead of main â€” nothing to PR"
            echo "has_diff=false" >> $GITHUB_OUTPUT
            echo "count=0"        >> $GITHUB_OUTPUT
            echo "title=no-diff"  >> $GITHUB_OUTPUT
            exit 0
          fi

          COUNT=$(printf '%s\n' "$COMMITS" | grep -c .)
          LATEST=$(git log -1 --format="%s")

          echo "has_diff=true" >> $GITHUB_OUTPUT
          echo "count=${COUNT}" >> $GITHUB_OUTPUT
          echo "title=ðŸš€ develop â†’ main | ${LATEST} (+${COUNT} commits)" >> $GITHUB_OUTPUT

          printf '%s' "$COMMITS" > /tmp/commits.txt

      - name: Generate PR body with Gemini
        id: ai
        if: steps.commits.outputs.has_diff == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          REPO:           ${{ github.repository }}
          BRANCH:         ${{ github.ref_name }}
          COMMIT_COUNT:   ${{ steps.commits.outputs.count }}
        run: |
          COMMITS=$(cat /tmp/commits.txt)
          SHORT="${{ github.sha }}"
          SHORT="${SHORT:0:7}"
          AI_TEXT=""

          if [ -n "$GEMINI_API_KEY" ]; then
            echo "Calling Gemini..."

            {
              printf 'You are a senior developer writing a Pull Request description.\n'
              printf 'Generate a professional PR description in markdown.\n\n'
              printf 'Rules:\n'
              printf 'Start with a one-paragraph summary of what this PR does\n'
              printf 'Use these sections (omit entire section if empty):\n'
              printf '  ## ðŸš€ New Features\n'
              printf '  ## ðŸ› Bug Fixes\n'
              printf '  ## â™»ï¸ Refactoring\n'
              printf '  ## ðŸ”§ Improvements\n'
              printf '  ## ðŸ“š Documentation\n'
              printf '  ## âš ï¸ Breaking Changes\n'
              printf 'End with "## ðŸ§ª Testing" noting CI passed (build, vet, tests green)\n'
              printf 'Output ONLY the markdown body, no preamble\n\n'
              printf 'Commits to summarize:\n'
              cat /tmp/commits.txt
            } > /tmp/prompt.txt

            PROMPT_JSON=$(jq -Rs '.' /tmp/prompt.txt)
            jq -n --argjson p "$PROMPT_JSON" \
              '{contents:[{parts:[{text:$p}]}],generationConfig:{maxOutputTokens:1024,temperature:0.3}}' \
              > /tmp/payload.json

            HTTP_CODE=$(curl -s -w "%{http_code}" -o /tmp/gemini.json \
              -X POST -H "Content-Type: application/json" \
              -d @/tmp/payload.json \
              "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}")

            echo "Gemini HTTP: ${HTTP_CODE}"
            if [ "$HTTP_CODE" = "200" ]; then
              AI_TEXT=$(jq -r '.candidates[0].content.parts[0].text // empty' /tmp/gemini.json)
              [ -n "$AI_TEXT" ] && echo "âœ… AI body generated" || echo "âš ï¸ Empty response"
            else
              echo "âš ï¸ Gemini HTTP ${HTTP_CODE}:"
              jq '.' /tmp/gemini.json || cat /tmp/gemini.json
            fi
          fi

          # Fallback
          if [ -z "$AI_TEXT" ]; then
            AI_TEXT=$(printf '## Summary\n\nAutomated PR from `develop` â†’ `main` with %s commit(s).\n\n## Changes\n\n```\n%s\n```\n\n## ðŸ§ª Testing\n\nCI passed âœ… â€” build, vet and tests all green.' \
              "$COMMIT_COUNT" "$COMMITS")
          fi

          printf '%s\n' "$AI_TEXT" > /tmp/pr_body.md
          printf '\n---\n> ðŸ¤– Generated by [commitai](https://github.com/%s) using Gemini AI\n> ðŸ“¦ Commit: `%s` | Branch: `%s`\n' \
            "$REPO" "$SHORT" "$BRANCH" >> /tmp/pr_body.md

          DELIM="PRBODY_$(head -c6 /dev/urandom | base64 | tr -dc 'A-Z0-9')"
          {
            echo "pr_body<<${DELIM}"
            cat /tmp/pr_body.md
            echo "${DELIM}"
          } >> $GITHUB_OUTPUT

          echo "--- preview ---"
          head -15 /tmp/pr_body.md

  # â”€â”€ 3. Cria ou atualiza PR via GitHub REST API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  open-pr:
    name: Open / Update Pull Request
    runs-on: ubuntu-latest
    needs: [ci, generate-pr-body]
    if: |
      needs.ci.outputs.passed == 'true' &&
      needs.generate-pr-body.outputs.has_diff == 'true'

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Create or update PR via GitHub REST API
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO:     ${{ github.repository }}
          TITLE:    ${{ needs.generate-pr-body.outputs.pr_title }}
          PR_BODY:  ${{ needs.generate-pr-body.outputs.pr_body }}
        run: |
          API="https://api.github.com/repos/${REPO}"
          AUTH="-H \"Authorization: Bearer ${GH_TOKEN}\""
          HDR_ACCEPT="-H \"Accept: application/vnd.github+json\""
          HDR_VER="-H \"X-GitHub-Api-Version: 2022-11-28\""

          echo "--- Checking existing open PRs develop â†’ main ---"

          # Extrai o owner para montar head no formato owner:branch
          OWNER="${REPO%%/*}"

          HTTP_CODE=$(curl -s -w "\n%{http_code}" -o /tmp/list_prs.json \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "${API}/pulls?base=main&head=${OWNER}:develop&state=open&per_page=1")

          HTTP_CODE=$(tail -1 <<< "$HTTP_CODE")
          echo "List PRs HTTP: ${HTTP_CODE}"
          cat /tmp/list_prs.json

          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Failed to list PRs (check GITHUB_TOKEN permissions)"
            exit 1
          fi

          PR_NUMBER=$(jq -r '.[0].number // empty' /tmp/list_prs.json)
          PR_URL=$(jq -r    '.[0].html_url // empty' /tmp/list_prs.json)

          # Escreve body em arquivo e serializa com jq (escaping seguro)
          printf '%s' "$PR_BODY" > /tmp/pr_body.md
          BODY_JSON=$(jq -Rs '.' /tmp/pr_body.md)

          if [ -n "$PR_NUMBER" ]; then
            echo "ðŸ”„ Updating existing PR #${PR_NUMBER}..."

            jq -n \
              --arg title "$TITLE" \
              --argjson body "$BODY_JSON" \
              '{title:$title, body:$body}' > /tmp/pr_payload.json

            HTTP_CODE=$(curl -s -w "\n%{http_code}" -o /tmp/pr_result.json \
              -X PATCH \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -H "Content-Type: application/json" \
              -d @/tmp/pr_payload.json \
              "${API}/pulls/${PR_NUMBER}")
            HTTP_CODE=$(tail -1 <<< "$HTTP_CODE")
            ACTION="updated"
          else
            echo "âœ¨ Creating new PR develop â†’ main..."

            jq -n \
              --arg title "$TITLE" \
              --argjson body "$BODY_JSON" \
              --arg base  "main" \
              --arg head  "${OWNER}:develop" \
              '{title:$title, body:$body, base:$base, head:$head}' > /tmp/pr_payload.json

            echo "--- Payload ---"
            cat /tmp/pr_payload.json

            HTTP_CODE=$(curl -s -w "\n%{http_code}" -o /tmp/pr_result.json \
              -X POST \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -H "Content-Type: application/json" \
              -d @/tmp/pr_payload.json \
              "${API}/pulls")
            HTTP_CODE=$(tail -1 <<< "$HTTP_CODE")
            ACTION="created"
          fi

          echo "${ACTION} PR â€” HTTP: ${HTTP_CODE}"
          echo "--- Response ---"
          cat /tmp/pr_result.json

          if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "201" ]; then
            echo "âŒ PR ${ACTION} failed (HTTP ${HTTP_CODE})"
            echo ""
            echo "Common causes:"
            echo "  422 â€” No commits ahead of base, or PR already exists with same head/base"
            echo "  403 â€” GITHUB_TOKEN missing 'pull-requests: write' permission"
            echo "  404 â€” Branch does not exist or token has no repo access"
            jq '.message // .' /tmp/pr_result.json || true
            exit 1
          fi

          PR_NUMBER=$(jq -r '.number'   /tmp/pr_result.json)
          PR_URL=$(jq -r    '.html_url' /tmp/pr_result.json)
          echo "âœ… PR #${PR_NUMBER} ${ACTION}: ${PR_URL}"

          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "pr_url=${PR_URL}"       >> $GITHUB_OUTPUT
          echo "action=${ACTION}"       >> $GITHUB_OUTPUT

      - name: Add labels
        if: steps.pr.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO:     ${{ github.repository }}
          PR_NUM:   ${{ steps.pr.outputs.pr_number }}
        run: |
          # Falha aqui nÃ£o quebra o workflow â€” labels sÃ£o opcionais
          HTTP_CODE=$(curl -s -w "\n%{http_code}" -o /dev/null \
            -X POST \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/json" \
            -d '{"labels":["automated-pr","ready-to-merge"]}' \
            "https://api.github.com/repos/${REPO}/issues/${PR_NUM}/labels")
          HTTP_CODE=$(tail -1 <<< "$HTTP_CODE")
          [ "$HTTP_CODE" = "200" ] \
            && echo "âœ… Labels added" \
            || echo "âš ï¸ Labels HTTP ${HTTP_CODE} â€” create labels 'automated-pr' and 'ready-to-merge' in Settings â†’ Labels"

      - name: Job summary
        env:
          PR_URL:    ${{ steps.pr.outputs.pr_url }}
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
          ACTION:    ${{ steps.pr.outputs.action }}
          COUNT:     ${{ needs.generate-pr-body.outputs.commit_count }}
        run: |
          ICON="âœ… PR criada"
          [ "$ACTION" = "updated" ] && ICON="ðŸ”„ PR atualizada"
          echo "## ${ICON}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Campo | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`develop\` â†’ \`main\` |" >> $GITHUB_STEP_SUMMARY
          echo "| CI | âœ… passou |" >> $GITHUB_STEP_SUMMARY
          echo "| Commits | ${COUNT} |" >> $GITHUB_STEP_SUMMARY
          echo "| PR | [#${PR_NUMBER} Abrir](${PR_URL}) |" >> $GITHUB_STEP_SUMMARY